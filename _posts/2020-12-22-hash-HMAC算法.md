---
layout: post
title: 2020-12-22-hash-HMAC算法
date: 2020-12-22
categories: blog
tags: [密码学,哈希]
description: hash-HMAC加密算法
typora-copy-images-to: ..\img
typora-root-url: ..
---

# Hmac算法

​	写题目看到了hash-hmac()加密函数，于是稍微了解一下hmac加密算法，顺便做个笔记，不然学了等于没学，看了也白看。

​	虽然基本上人人都懂哈希（hash）算法，但说Hmac算法之前还是得简单提一嘴哈希算法：

**哈希算法**（Hash）又称摘要算法（DiHgest），原理是对一组信息数据通过某种函数（这种作用的函数可以统称为哈希函数）进行计算，得到一个固定长度的**信息摘要**。

​	而通过这个定长的信息摘要，几乎不可能逆推出原始的数据。并且，相同的原始数据得到的信息摘要一定相同，不同的原始数据得到相同摘要的可能性则非常非常小（越长的原始数据，信息摘要相同的可能性越小）。这就使得这个信息摘要几乎具有唯一性，可以用来唯一认证这个原始数据。这个特性可以用在密码验证和保存机制中（机密性），亦可以用来校验信息（完整性）。

​	例如大部分网站存储用户口令，存储的并不是口令本身，而是口令的哈希值，这样即使黑客通过手段拿到了数据库中用户的哈希口令，也没法通过这个口令登录用户系统。除非使用穷举的方法“碰撞”出哈希值与它相等的口令来。

​	但黑客也不一定要用暴力穷举的方法破解哈希口令，常用的针对哈希口令的攻击，叫做“彩虹表攻击”。

就是一个预先计算好的常用口令和它们的MD5的对照表：

| 常用口令 | MD5                              |
| :------- | :------------------------------- |
| hello123 | f30aa7a662c728b7407c54ae6bfd27d1 |
| 12345678 | 25d55ad283aa400af464c76d713c07ad |
| passw0rd | bed128365216c019988915ed3add75fb |
| 19700101 | 570da6d5277a646f6552b8832012f5dc |
| …        | …                                |
| 20201231 | 6879c0ae9117b50074ce0a0d4c843060 |

如果用户使用了以上常见口令，黑客就很容易通过MD5值找到这个口令。

而最简单的抵御彩虹表攻击的方法，是对每个口令额外添加随机数，这个方法称之为加盐（salt）：

```php
$digest = hash($salt+$inputPassword)
```

加盐的目的在于使黑客的彩虹表失效，即使用户使用常用口令，也无法从MD5反推原始口令。

Hmac算法就是一种基于密钥的消息认证码算法，它的全称是Hash-based Message Authentication Code，是一种更安全的消息摘要算法。

Hmac算法总是和某种哈希算法配合起来用的。例如PHP中的hash-hmac()函数的第一个参数就是指定一个哈希函数，如："md5"，"sha256"，"haval160,4" 等

hash-hmac-algos()函数可以用来返回所有可用的hash()函数，它的返回值是一个由所有可用hash函数名字组成的列表。

------

HMAC算法除了需要信息摘要算法外，还需要一个密钥。HMAC的密钥可以是任何长度，如果密钥的长度超过了摘要算法信息分组的长度，则首先使用摘要算法计算**密钥的摘要**作为新的密钥。一般不建议使用太短的密钥，因为密钥的长度与安全强度是相关的。通常选取密钥长度不小于所选用摘要算法输出的信息摘要的长度。

> HMAC算法本身并不复杂，起需要有一个哈希函数，我们记为**H**。同时还需要有一个密钥，我们记为**K**。每种信息摘要函数都对信息进行分组，每个信息块的长度是固定的，我们记为**B**（如：SHA1为512位，即64字节）。每种信息摘要算法都会输出一个固定长度的信息摘要，我们将信息摘要的长度记为**L**（如MD5为16字节，SHA-1为20个字节）。正如前面所述，K的长度理论上是任意的，一般为了安全强度考虑，选取不小于L的长度。

HMAC算法其实就是利用密钥和明文进行两轮哈希运算，以公式可以表示如下：

```
HMAC（K，M）=H（K⊕opad∣H（K⊕ipad∣M））
```

其中：

Ipad为0x36重复B次

Opad为0x5c重复B次

M 代表一个消息数据组

### **HMAC算法的运算步骤：**

（1）检查[密钥](https://baike.baidu.com/item/密钥)K的长度。如果K的长度大于B则先使用摘要算法计算出一个长度为L的新密钥。如果后K的长度小于B，则在其后面追加0来使其长度达到B。

（2）将上一步生成的B字长的密钥字符串与ipad做异或运算。

（3）将需要处理的数据流M填充至第二步的结果字符串中。

（4）使用哈希函数H计算上一步中生成的数据流的信息摘要值。

（5）将第一步生成的B[字长](https://baike.baidu.com/item/字长)密钥字符串与opad做异或运算。

（6）再将第四步得到的结果填充到第五步的结果之后。

由上述描述过程，我们知道HMAC算法的计算过程实际是对原始数据做了两次**类似于**加盐处理的哈希加密过程。

